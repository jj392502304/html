<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>净水器销售登录注册</title>
    <meta name="description" content="particles.js is a lightweight JavaScript library for creating particles.">
    <meta name="author" content="Vincent Garreau"/>
    <meta name="viewport"
          content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <link rel="stylesheet" media="screen" href="css/style.css">
    <link rel="stylesheet" type="text/css" href="css/reset.css"/>
    <link rel="stylesheet" href="https://cdn.staticfile.org/twitter-bootstrap/3.3.7/css/bootstrap.min.css">
    <script src="https://cdn.staticfile.org/jquery/2.1.1/jquery.min.js"></script>
    <script src="https://cdn.staticfile.org/twitter-bootstrap/3.3.7/js/bootstrap.min.js"></script>
    <script src="../js/public.js"></script>
    <script type='text/javascript'>
        var code; //在全局定义验证码

        function createCode() {
            code = "";
            var codeLength = 4;//验证码的长度
            var checkCode = document.getElementById("code");
            var random = new Array(0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 'A', 'B', 'C', 'D', 'E', 'F', 'G', 'H', 'I', 'J', 'K', 'L', 'M', 'N', 'O', 'P', 'Q', 'R',
                'S', 'T', 'U', 'V', 'W', 'X', 'Y', 'Z');//随机数
            for (var i = 0; i < codeLength; i++) {//循环操作
                var index = Math.floor(Math.random() * 36);//取得随机数的索引（0~35）
                code += random[index];//根据索引取得随机数加到code上
            }
            checkCode.value = code;//把code值赋给验证码
        }

    </script>
    <style type='text/css'>
        .mar {
            margin-bottom: 10px;
        }

        #code {
            margin-left: 10px;
            width: 70px;
            background: dodgerblue;
            color: white;
            border-width: 0px;
            border-radius: 3px;
            outline: none;
            font-family: Microsoft YaHei;
            cursor: pointer;
            font-size: 14px;
        }

        .btn-a {
            background: dodgerblue;
            color: white;
            border-width: 0px;
            border-radius: 3px;
            outline: none;
            font-family: Microsoft YaHei;
            cursor: pointer;
            font-size: 14px;
        }

        .btn-a:hover {
            background: #5599FF;
        }
    </style>
</head>
<body onload="createCode()">

<div id="particles-js">
    <div class="login" style="height: 400px;width: 800px">
        <div class="login-top">
            登录
        </div>
        <div class="login-center clearfix">
            <div class="login-center-img"><img src="img/name.png"/></div>
            <div class="login-center-input">
                <input id="phone" style="width: 90%" type="text" name="" value="" placeholder="请输入手机号"
                       onfocus="this.placeholder=''" onblur="this.placeholder='请输入手机号'"/>
                <div class="login-center-input-text">手机号</div>
            </div>
        </div>
        <div class="login-center clearfix">
            <div class="login-center-img"><img src="img/password.png"/></div>
            <div class="login-center-input">
                <input id="password" style="width: 86%" type="password" name="" value="" placeholder="请输入您的密码"
                       onfocus="this.placeholder=''" onblur="this.placeholder='请输入您的密码'"/>
                <div class="login-center-input-text">密码</div>
                <a href="#" onclick="cp()">忘记密码</a>
            </div>
        </div>
        <div class="login-center clearfix">
            <div class="login-center-img"><img src="img/timg.jpg"/></div>
            <div class="login-center-input">
                <input id="validate" style="width: 85%" type="password" name="" value="" placeholder="请输入右侧验证码"
                       onfocus="this.placeholder=''" onblur="this.placeholder='请输入右侧验证码'"/>
                <div class="login-center-input-text">验证码</div>
                <input type="button" id="code" onclick="createCode()" title='点击更换验证码'/>
                <p id="tishi2" style="color: red"></p>
            </div>
        </div>

        <div class="login-button">
            登录
        </div>
        <a href="register.html" style="font-size: 18px;position: absolute;left: 48%">注册</a>
    </div>
    <div class="sk-rotating-plane"></div>
</div>
<div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
                <h4 class="modal-title" id="myModalLabel">修改密码</h4>
            </div>
            <div class="modal-body">
                <!--<div class="input-group mar">-->
                    <!--<span class="input-group-addon">请输入账　号</span>-->
                    <!--<input type="text" class="form-control" placeholder="">-->
                <!--</div>-->
                <div class="input-group mar">
                    <span class="input-group-addon">请输入手机号</span>
                    <input type="text" id="phone1" class="form-control" placeholder="">
                    <span class="input-group-addon" style="background: white"><button  style="background: white;color: black;width: 100%;height: 100%;font-size: 16px;border: 0" id="a1">获取验证码</button></span>
                </div>
                <div class="input-group mar">
                    <span class="input-group-addon">请输入验证码</span>
                    <input type="text" id="code1" class="form-control" placeholder="">
                </div>
                <div class="input-group mar">
                    <span class="input-group-addon">请输入新密码</span>
                    <input type="password" id="pwd1" class="form-control" placeholder="">
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal">关闭</button>
                <button type="button" class="btn btn-primary" id="sub">提交更改</button>
            </div>
        </div><!-- /.modal-content -->
    </div><!-- /.modal -->
</div>
<!-- scripts -->
<script src="js/particles.min.js"></script>
<script src="js/app.js"></script>
<script type="text/javascript">
    var countdown = 0;
    $(function () {
        $("#a1").click(function () {
            var phone1=$("#phone1").val();
            if (!(/^1[3|5][0-9]\d{4,8}$/.test(phone1))) {
                alert("手机号码格式不对")
                $("#phone1").focus();
                return;
            } else if (phone1.length != 11) {
                alert("手机号码格式不对")
                $("#phone1").focus();
                return;
            } else {
                $.ajax({
                    type: "get",
                    url: http + "/code",
                    data: {
                        phone:phone1,
                        type:1
                    },
//            contentType: "application/json",
                    dataType: "json",
                    success: function (data) {
                        if (data.code == 200) {
                            sendemail();
                        } else {
                            alert(data.message);
                        }
                    }
                });

            }

        });
        $("#sub").click(function () {
            var code1=$("#code1").val();
            var pwd1=$("#pwd1").val();
            if(code1.length==0){
                alert("验证码不能为空！");
                return;
            }
            if(pwd1.length<6){
                alert("密码最小长度为6");
                return;
            }

            $.ajax({
                type: "post",
                url: http + "/newpassword",
                data: {
                    phone:$("#phone1").val(),
                    code:code1,
                    password:pwd1
                },
//                processData:false,
//            contentType: "application/json",
                dataType: "json",
                success: function (data) {
                    if (data.code == 200) {
                        $("#myModal").modal('hide');
                       alert("修改成功！");
                    } else {
                        alert(data.message);
                    }
                }
            });

        });

    })

    function sendemail() {
        countdown=60;
        var obj = $("#a1");
        settime(obj);

    }

    function settime(obj) { //发送验证码倒计时
       if(countdown==0){
           obj[0].innerHTML="获取验证码";
           obj.attr("disabled",false);
           return;
       }else {
           obj.attr("disabled",true);
           obj[0].innerHTML="重新获取"+countdown+"s";
           countdown--;
       }
        setTimeout(function () {
                settime(obj)
            }, 1000);
    }

    function checkMobile() {
        var sMobile = $("#phone").val();
        if (!(/^1[3|5][0-9]\d{4,8}$/.test(sMobile))) {

            $("#phone").focus();
            $("#tishi3").html("手机号码格式不对")
            return false;
        } else if (sMobile.length != 11) {
            $("#phone").focus();
            $("#tishi3").html("手机号码格式不对")
            return false;
        } else {
            $("#tishi3").html("")
            return true;
        }
    }

    function cp() {
        $("#myModal").modal('show');
    }

    function hasClass(elem, cls) {
        cls = cls || '';
        if (cls.replace(/\s/g, '').length == 0) return false; //当cls没有参数时，返回false
        return new RegExp(' ' + cls + ' ').test(' ' + elem.className + ' ');
    }

    function addClass(ele, cls) {
        if (!hasClass(ele, cls)) {
            ele.className = ele.className == '' ? cls : ele.className + ' ' + cls;
        }
    }

    function removeClass(ele, cls) {
        if (hasClass(ele, cls)) {
            var newClass = ' ' + ele.className.replace(/[\t\r\n]/g, '') + ' ';
            while (newClass.indexOf(' ' + cls + ' ') >= 0) {
                newClass = newClass.replace(' ' + cls + ' ', ' ');
            }
            ele.className = newClass.replace(/^\s+|\s+$/g, '');
        }
    }

    document.querySelector(".login-button").onclick = function () {

        if ($("#validate").val().toLowerCase() != code.toLowerCase()) {
            $("#validate").focus();
            $("#tishi2").html("验证码不正确")
            return;
        } else {
            $("#tishi2").html("")
        }
        if (checkMobile() == false) {
            return;
        }
        var acccount = $("#phone").val();
        var password = $("#password").val();
        $.ajax({
            type: "POST",
            url: http + "/suser/login",
            data: {
                "account": acccount,
                "password": password
            },
//            contentType: "application/json",
            dataType: "json",
            success: function (data) {
                if (data.code == 200) {
                    sessionStorage.setItem("login", JSON.stringify(data.data));
                    window.location.href = "../index.html";
                } else {
                    alert("密码错误！");
                }
            }
        });
//        addClass(document.querySelector(".login"), "active")
//        setTimeout(function(){
//            addClass(document.querySelector(".sk-rotating-plane"), "active")
//            document.querySelector(".login").style.display = "none"
//        },800)
//        setTimeout(function(){
//            removeClass(document.querySelector(".login"), "active")
//            removeClass(document.querySelector(".sk-rotating-plane"), "active")
//            document.querySelector(".login").style.display = "block"
//            alert("登录成功")
//
//        },5000)
    }
</script>
<div style="text-align:center;">
</div>
</body>
</html>